<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    //function to parse our response
    const parseJSON = (xhr, content) => {
      //parse response (obj will be empty in a 204 updated)
      const obj = JSON.parse(xhr.response);

      //if message in response, add to screen
      if (obj.message) {
        const p = document.createElement('p');
        p.textContent = `Message: ${obj.message}`;
        content.appendChild(p);
      }

      if (obj.blog) {
        writeBlogHTML(obj.blog, content);
      }
    };

    const writeBlogHTML = (blog, content) => {
      let html = "";
      if (blog.entries) {
        for (let i = 0; i < blog.entries.length; i++) {
          html += "<div class='entry'>";
          html += "<h3>" + blog.entries[i].title + "</h3>";
          if (blog.entries[i].image) {
            html += "<img class='entry-img' src='" + blog.entries[i].image + "'/>";
          }
          html += "<p>" + blog.entries[i].date + "</p>";
          html += "<p>" + blog.entries[i].entry + "</p>";
          html += "</div>";

          content.innerHTML = html;
        }
      }
    };

    //function to handle our response
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');

      console.log(xhr.getResponseHeader ('etag'));

      //Check network tag for real status code
      console.log(xhr.status);

      //check the status code
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Create</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 304: //if not modified
          content.innerHTML = '<b>Not Modified</b>';
          break;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 401:
          content.innerHTML = '<b>Unauthorized</b>';
          break;
        case 404: //if not found
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
        default: //any other status code
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }

      if (parseResponse) {
        parseJSON(xhr, content);
      } else {
        console.log('received');
      }
    };

    const requestUpdate = (e, userForm) => {
      const method = userForm.querySelector('#methodSelect').value;
      const url = userForm.querySelector('#urlField').value;

      if (url === '/getPrivatePosts') {
        userForm.action = url;
      }

      const xhr = new XMLHttpRequest();

      xhr.open(method, url);
      xhr.setRequestHeader('Accept', 'application/json');

      if (url !=='/getPrivatePosts' || url === '/getPrivatePosts' && method === 'head') {
        if (method == 'get') {
          xhr.onload = () => handleResponse(xhr, true);
        } else {
          xhr.onload = () => handleResponse(xhr, false);
        }
      }

      xhr.send();

      if (url !== '/getPrivatePosts' || url === '/getPrivatePosts' && method === 'head') {
        e.preventDefault();
        return false;
      }
    };

    const sendPost = (e, blogForm) => {
      const blogAction = blogForm.getAttribute('action');
      const blogMethod = blogForm.getAttribute('method');

      const titleField = blogForm.querySelector('#titleField');
      const dateField = blogForm.querySelector('#dateField');
      const imageField = blogForm.querySelector('#imageField');
      const entryField = blogForm.querySelector('#entryField');
      const privacy = blogForm.querySelector('#privacy');

      const xhr = new XMLHttpRequest();

      xhr.open(blogMethod, blogAction);

      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');

      xhr.onload = () => handleResponse(xhr, true);

      const formData = `title=${titleField.value}&date=${dateField.value}&image=${imageField.value}&entry=${entryField.value}&privacy=${privacy.value}`;

      xhr.send(formData);

      e.preventDefault();
      return false;
    };

    const init = () => {
      //grab form
      const blogForm = document.querySelector('#blogForm');
      const userForm = document.querySelector('#userForm');

      //create handler
      const addPost = (e) => sendPost(e, blogForm);
      const getPosts = (e) => requestUpdate(e, userForm);

      //attach submit event (for clicking submit or hitting enter)
      blogForm.addEventListener('submit', addPost);
      userForm.addEventListener('submit', getPosts);
    };

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <form id="blogForm" action="/addPost" method="post">
      <label for="title">Title: </label>
      <input id="titleField" type="text" name="title" />
      <label for="date">Date: </label>
      <input id="dateField" type="date" name="date"/>
      <label for="image">Post Image: </label>
      <input id="imageField" type="url" name="postImage"/>
      <textarea id="entryField" name="entry" form="blogForm" placeholder="Write entry here"></textarea>
      <select id='privacy'>
        <option value='public'>Public</option>
        <option value='private'>Private</option>
      </select>
      <input type="submit" value="Add Post" />
    </form>
    <form id="userForm" action="/getPosts" method="get">
      <select id='urlField'>
        <option value='/getPosts'>Public Posts</option>
        <option value='/getPrivatePosts'>Secrets</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get Posts" />
    </form>
  </section>
  <section id="content">
  </section>
</body>
</html>
